<?php

// Only for testing purposes
if (defined('IONOS_WP_ENV_MODE') && IONOS_WP_ENV_MODE === 'test' && ! class_exists(
  'Ionos\Security\Controllers\WPScan'
)) {
  require_once __DIR__ . '/class-wpscan.php';
}

if (method_exists('Ionos\Security\Controllers\WPScan', 'dashboad_widget_content')) {
  global $wp_filter;
  $controller = null;

  // Check if the 'admin_init' hook exists in the global $wp_filter
  if (isset($wp_filter['admin_init'])) {
    // Loop through the hooks attached to 'admin_init'
    foreach ($wp_filter['admin_init']->callbacks as $priority => $callbacks) {
      foreach ($callbacks as $callback) {
        // Check if the callback is an object method
        if (is_array($callback['function']) && is_object($callback['function'][0])) {
          // The first element of the callback array is the object
          $object = $callback['function'][0];
          $method = $callback['function'][1];

          // Check if the method is 'check_scan_result'
          if ('check_scan_result' === $method) {
            $controller = $object;
            $controller->dashboad_widget_content();
            return;
          }
        }
      }
    }
  }
} else {
  if (! in_array('ionos-security/ionos-security.php', array_keys(get_plugins()), true)) {
    printf('<h4>%s</h4>', \esc_html__('Please, install the IONOS Security Plugin', 'ionos-essentials'));
  } elseif (is_plugin_inactive('ionos-security/ionos-security.php')) {
    printf('<h4>%s</h4>', \esc_html__('Please, activate the IONOS Security Plugin', 'ionos-essentials'));
  }
}
